# Implementation Plan

## 実装タスク

- [x] 1. プロジェクト基盤のセットアップ
- [x] 1.1 Next.js 15プロジェクトの初期化と基本設定
  - Next.js 15、React 19、TypeScript 5.xでプロジェクトを初期化
  - Tailwind CSS 3.xを設定し、カスタムテーマとレスポンシブブレークポイントを定義
  - ESLintとPrettierを設定し、コード品質ルールを適用
  - `.gitignore`に環境変数ファイル（`.env.local`）を追加
  - _Requirements: すべての要件に必要な基盤_

- [x] 1.2 Supabaseプロジェクトのセットアップとデータベース設計
  - Supabaseプロジェクトを作成し、接続情報を取得
  - 環境変数（`NEXT_PUBLIC_SUPABASE_URL`、`NEXT_PUBLIC_SUPABASE_ANON_KEY`）を設定
  - `diaries`テーブルをマイグレーションで作成（UUID主キー、ユーザーID外部キー、日付、入力テキスト、生成コンテンツ、タイムスタンプ）
  - Row Level Security (RLS)ポリシーを設定し、ユーザーが自分の日記のみにアクセス可能にする
  - インデックス（`idx_diaries_user_id_date`）を作成し、クエリパフォーマンスを最適化
  - `updated_at`自動更新トリガーを設定
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 6.3_

- [x] 1.3 TypeScript型定義の作成
  - 日記関連の型定義（`Diary`、`DiaryCreateInput`、`DiaryUpdateInput`、`DiaryListItem`）を作成
  - AI生成関連の型定義（`GenerateRequest`、`GenerateResponse`、`GenerateErrorResponse`、`AIGenerationState`）を作成
  - エラー関連の型定義（`AppError`、`ValidationError`、`AuthenticationError`、`AIGenerationError`、`DatabaseError`）を作成
  - ユーティリティ型を定義（Result型、エラーコード等）
  - _Requirements: 型安全性の徹底_

- [x] 2. 認証システムの構築
- [x] 2.1 Supabase認証の統合とヘルパー関数の作成
  - Supabaseクライアントのサーバーサイド版を作成（`createServerClient`関数）
  - Supabaseクライアントのクライアントサイド版を作成（`createBrowserClient`関数）
  - Middlewareで認証状態を検証し、未認証ユーザーをログインページにリダイレクト
  - 認証済みユーザーがログインページにアクセスするとダッシュボードにリダイレクト
  - _Requirements: 6.1, 6.2, 6.4_

- [x] 2.2 ログイン・サインアップページの作成
  - ログインページ（`/login`）を作成し、Email/Passwordフォームを実装
  - サインアップページ（`/signup`）を作成し、ユーザー登録フォームを実装
  - フォームバリデーション（メールアドレス形式、パスワード長）を実装
  - 認証エラー時のユーザーフィードバック（エラーメッセージ表示）を実装
  - 認証成功時の適切なリダイレクト処理を実装
  - _Requirements: 6.1, 6.2_

- [x] 3. 汎用UIコンポーネントの作成
- [x] 3.1 基本UIプリミティブの実装
  - Buttonコンポーネント（primary/secondary/dangerバリアント、sm/md/lgサイズ、ローディング状態）を作成
  - Inputコンポーネント（text/email/password/dateタイプ、エラー表示、無効化状態）を作成
  - Cardコンポーネント（汎用コンテナ、カスタムクラス対応）を作成
  - Spinnerコンポーネント（sm/md/lgサイズ、ローディングインジケータ）を作成
  - Modalコンポーネント（開閉制御、タイトル、カスタムコンテンツ）を作成
  - すべてのコンポーネントにTailwind CSSでレスポンシブスタイルを適用
  - _Requirements: 7.1, 7.2, 7.3, 7.5_

- [x] 3.2 レイアウトコンポーネントの作成
  - Headerコンポーネント（アプリケーション名、ナビゲーション、ログアウトボタン）を作成
  - Footerコンポーネント（著作権表示、リンク）を作成
  - ルートレイアウト（`layout.tsx`）でHeaderとFooterを統合
  - モバイル・タブレット・デスクトップでレスポンシブレイアウトを実装
  - _Requirements: 7.1, 7.2, 7.5_

- [x] 4. AI生成機能の実装
- [x] 4.1 プロンプトテンプレートとAI生成サービスの作成
  - プロンプトテンプレート関数（`generateDiaryPrompt`）を作成し、ユーザー入力と日付から日記生成プロンプトを生成
  - LLM API（Claude APIまたはOpenAI API）を調査・選定し、React 19互換性とレスポンスタイムを確認
  - AIGenerationServiceクラスを作成し、LLM APIとの通信を抽象化
  - プロンプト生成、API呼び出し、レスポンス処理、エラーハンドリングを実装
  - 30秒のタイムアウト処理を実装
  - _Requirements: 2.1, 2.4, 2.6, 2.7_

- [x] 4.2 AI生成API Routeの作成
  - `/api/ai/generate` API Routeエンドポイントを作成
  - リクエストボディのバリデーション（`userInput`が1文字以上、`date`が有効な形式）を実装
  - 認証トークンの検証（Supabase Authセッション確認）を実装
  - AIGenerationServiceを呼び出し、日記文章を生成
  - エラーハンドリング（400, 401, 429, 500, 504エラー）を実装
  - レスポンス形式（`GenerateResponse`または`GenerateErrorResponse`）を統一
  - _Requirements: 2.1, 2.2, 2.3, 2.6, 2.7, 6.5, 8.2, 8.3, 8.5_

- [x] 5. 日記エディタコンポーネントの実装
- [ ] 5.1 リッチテキストエディタライブラリの選定と統合（将来拡張）
  - React 19互換性のあるリッチテキストエディタライブラリ（Lexical、Tiptap、Slate等）を調査・選定
  - TypeScript型定義の品質、バンドルサイズ、メンテナンス状況を評価
  - 選定したライブラリをインストールし、基本的な編集機能（太字、斜体、箇条書き）を実装
  - エディタコンポーネントのインターフェース（`initialContent`、`onChange`、`readOnly`、`showCharCount`）を定義
  - XSS攻撃防止のため、エディタ出力をサニタイズ（DOMPurifyなどを使用）
  - _Requirements: 3.2, 3.3_
  - _Note: 現在はTextareaコンポーネントで実装済み。リッチテキスト編集は将来的な拡張として検討_

- [x] 5.2 DiaryEditorコンポーネントの作成
  - DiaryEditorコンポーネント（Client Component）を作成し、日記入力フォームを実装
  - 日付選択フィールドを追加し、デフォルトで今日の日付を設定
  - マルチラインテキスト入力エリア（`userInput`）を追加し、プレースホルダーテキストと文字数カウントを表示
  - 入力が空の場合「AI生成」ボタンを無効化
  - AI生成状態管理（`idle`、`loading`、`success`、`error`）をReact useStateで実装
  - 処理時間カウンターを実装し、15秒以降は処理時間を表示
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7_

- [x] 5.3 AI生成UIとプレビュー機能の実装
  - 「AI生成」ボタンをクリックすると、`/api/ai/generate`にPOSTリクエストを送信
  - AI生成処理中、ローディングインジケータとボタンテキスト変更を表示
  - 15秒以降、処理時間を秒単位で表示（例：「処理中... (18秒)」）
  - 生成結果を受信したら、プレビューエリア（青色背景）に日記文章を表示
  - 「採用」ボタンと「再生成」ボタンを表示
  - 「再生成」ボタンをクリックすると、元の入力内容を保持したまま再度AI生成を実行
  - エラー発生時、エラーメッセージ（赤色背景）と「再試行」ボタンを表示
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10, 3.8_

- [x] 5.4 日記編集と保存機能の実装
  - 「採用」ボタンをクリックすると、生成された日記文章をテキストエディタに転送
  - ユーザーが日記内容を編集できるようにし、リアルタイムで変更を反映
  - 文字数カウント表示を提供
  - 「保存」ボタンをクリックすると、`createDiary` Server Actionを呼び出してデータベースに保存
  - 保存成功時、日記一覧ページにリダイレクト（保存中はローディングオーバーレイ表示）
  - 保存失敗時、エラーメッセージを表示
  - contentまたはuserInputが空の場合、「保存」ボタンを無効化
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9_

- [x] 6. 日記CRUD操作の実装
- [x] 6.1 createDiary Server Actionの作成
  - `createDiary` Server Actionを作成し、新規日記をSupabaseデータベースに保存
  - 入力バリデーション（`userInput`が1文字以上、`content`が1文字以上）を実装
  - 認証済みユーザーのIDを取得し、`user_id`フィールドに設定
  - Supabaseクライアント（サーバーサイド）を使用してデータベースに挿入
  - 保存成功時、`diaryId`を返す
  - 保存失敗時、エラーメッセージを返す
  - RLSポリシーにより、ユーザーは自分の日記のみを作成可能
  - revalidatePath()でキャッシュ無効化
  - _Requirements: 3.5, 3.6, 3.7, 4.1, 4.3, 4.5, 8.4, 8.5_

- [x] 6.2 updateDiary Server Actionの作成
  - `updateDiary` Server Actionを作成し、既存の日記をデータベースで更新
  - 入力バリデーション（`diaryId`が存在、`content`が1文字以上）を実装
  - 認証済みユーザーが該当日記の所有者であることを確認
  - Supabaseクライアント（サーバーサイド）を使用してデータベースを更新
  - `updated_at`タイムスタンプが自動更新されることを確認（トリガー）
  - 更新成功時、成功レスポンスを返す
  - 更新失敗時、エラーメッセージを返す
  - RLSポリシーにより、他のユーザーの日記は更新不可
  - _Requirements: 4.5, 6.3, 8.4, 8.5_

- [x] 6.3 deleteDiary Server Actionの作成
  - `deleteDiary` Server Actionを作成し、既存の日記をSupabaseデータベースから削除
  - 入力バリデーション（`diaryId`が存在）を実装
  - 認証済みユーザーが該当日記の所有者であることを確認
  - Supabaseクライアント（サーバーサイド）を使用してデータベースから物理削除
  - 削除成功時、成功レスポンスを返す
  - 削除失敗時、エラーメッセージを返す
  - RLSポリシーにより、他のユーザーの日記は削除不可
  - _Requirements: 6.3, 8.4, 8.5_

- [x] 7. 日記一覧・詳細ページの実装
- [x] 7.1 DiaryCardコンポーネントの作成
  - DiaryCardコンポーネント（プレゼンテーショナル）を作成し、1件の日記情報を表示
  - 日付、冒頭100文字のプレビューを表示
  - Next.js Linkコンポーネントで日記詳細ページへのナビゲーションを実装（カード全体がクリッカブル）
  - Tailwind CSSでカードスタイルとレスポンシブデザインを適用
  - _Requirements: 5.2_

- [x] 7.2 日記一覧ページの作成
  - 日記一覧ページ（`/diaries`）をServer Componentとして作成
  - Supabaseクライアント（サーバーサイド）でユーザーの日記を新しい順に取得
  - 日記データが0件の場合、空状態メッセージ（アイコン付き「まだ日記がありません」）と「最初の日記を作成」ボタンを表示
  - 日記データがある場合、DiaryCardコンポーネントを使用してグリッドレイアウトで一覧表示
  - 「新規作成」ボタンをヘッダー部に配置し、新規作成ページへのリンクを設定
  - レスポンシブレイアウト（モバイル: 1列、タブレット: 2列、デスクトップ: 3列）を実装
  - _Requirements: 5.1, 5.2, 5.3, 5.7, 7.1, 7.2, 8.1_

- [x] 7.3 日記詳細ページの作成
  - 日記詳細ページ（`/diaries/[id]`）をServer Componentとして作成
  - URLパラメータから`diaryId`を取得し、Supabaseから該当日記を取得
  - 日記が存在しない、または他のユーザーの日記の場合、日記一覧ページにリダイレクト
  - 日付、ユーザー入力メモ（灰色背景で区別）、完全な日記内容、作成日時、更新日時を表示
  - 「編集」ボタンと「削除」ボタンを追加
  - 「削除」ボタンをクリックすると、削除確認ダイアログ（Modal）を表示
  - 削除確認後、`deleteDiary` Server Actionを呼び出し、一覧ページにリダイレクト
  - 「一覧に戻る」リンクを追加
  - _Requirements: 5.4, 5.5, 5.6, 8.1_

- [x] 7.4 日記編集ページの作成
  - 日記編集ページ（`/diaries/[id]/edit`）を作成
  - URLパラメータから`diaryId`を取得し、Supabaseから該当日記を取得
  - DiaryEditorコンポーネントを使用し、既存の日付、ユーザー入力、日記内容を表示
  - ユーザーが日記内容を編集できるようにし、リアルタイムで変更を反映
  - 「保存」ボタンをクリックすると、`updateDiary` Server Actionを呼び出してデータベースを更新
  - 保存成功時、日記詳細ページにリダイレクト
  - 保存失敗時、エラーメッセージを表示
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 8. 新規日記作成ページの実装
- [x] 8.1 新規日記作成ページの作成
  - 新規日記作成ページ（`/diaries/new`）を作成
  - DiaryEditorコンポーネントを使用
  - 日付選択フィールドをデフォルトで今日の日付に設定
  - ユーザー入力、AI生成、編集、保存までの完全なフローを統合
  - 保存成功時、日記一覧ページにリダイレクト
  - エラー表示機能を実装
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 2.1-2.10, 3.1-3.9_

- [x] 9. エラーハンドリングとバリデーションの強化
- [ ] 9.1 統一エラーハンドリングシステムの実装
  - エラークラス（`AppError`、`ValidationError`、`AuthenticationError`、`AIGenerationError`、`DatabaseError`）を作成
  - エラーロガー（`logError`関数）を作成し、開発環境でコンソールログ、本番環境で外部ログサービスに送信
  - API Routesとサーバーアクションで統一エラーレスポンス形式を適用
  - クライアントサイドでエラーメッセージをユーザーフレンドリーに表示
  - _Requirements: 8.4, 8.5_

- [ ] 9.2 入力バリデーションの実装
  - フロントエンド: `userInput`の長さ検証（1文字以上）、日付の検証（有効な日付形式）を実装
  - バックエンド: API RoutesとServer Actionsですべての入力を再検証
  - データベース: CHECK制約で最終的なデータ整合性を保証（contentは1文字以上）
  - リアルタイムバリデーションフィードバックをボタン無効化で表示
  - _Requirements: 1.4, 1.5, 7.4, 8.5_

- [x] 10. レスポンシブデザインとアクセシビリティの最適化
- [ ] 10.1 レスポンシブレイアウトの検証と調整
  - モバイル（375px、768px未満）でレイアウトが適切に表示されることを確認
  - タブレット（768px以上、1024px未満）でレイアウトが適切に表示されることを確認
  - デスクトップ（1024px以上、1920px）でレイアウトが適切に表示されることを確認
  - Tailwind CSSのブレークポイント（sm、md、lg、xl）を活用
  - タッチデバイスでボタンのタップ領域を十分に確保
  - _Requirements: 7.1, 7.2_

- [ ] 10.2 アクセシビリティとUX改善
  - すべてのボタンに適切なaria-label属性を追加
  - フォーカス状態を明確にするため、キーボードナビゲーション対応を強化
  - ローディング状態、エラー状態、成功状態を視覚的に明確に表示
  - ボタンのホバー・アクティブ状態を200ms以内で視覚フィードバック
  - カラーコントラストをWCAG AA基準に準拠
  - _Requirements: 7.3, 7.4, 7.5_

- [x] 11. パフォーマンス最適化
- [ ] 11.1 コード分割とバンドルサイズ最適化
  - リッチテキストエディタを動的インポート（`next/dynamic`）で遅延ロード
  - Tailwind CSSの未使用スタイルをPurgeで削除
  - 初期JSバンドルサイズが200KB以下（gzip圧縮後）であることを確認
  - Tree Shakingにより未使用コードを削除
  - _Requirements: 8.1_

- [ ] 11.2 データベースクエリ最適化
  - 日記一覧では冒頭100文字のみを取得（JavaScriptの`substring(0, 100)`）
  - インデックス（`idx_diaries_user_id_date`）が適切に使用されていることを確認
  - 100件の日記を持つユーザーの一覧取得が高速であることを検証
  - Server Componentsでデータフェッチを行い、初期ロードを高速化
  - _Requirements: 9.1, 9.4_

- [x] 12. テストの実装
- [ ] 12.1 ユニットテストの作成
  - `generateDiaryPrompt`関数のテスト（プロンプト生成、日付フォーマット）を作成
  - `AIGenerationService.generateDiary`のテスト（モックしたLLM APIレスポンス処理）を作成
  - エラークラスのテスト（ステータスコード、メッセージ）を作成
  - 日付フォーマット関数、入力バリデーション関数のテストを作成
  - _Requirements: テスト戦略に基づく_

- [ ] 12.2 統合テストの作成
  - `/api/ai/generate` API Routeのテスト（正常系、異常系、認証エラー、タイムアウト）を作成
  - `createDiary`、`updateDiary`、`deleteDiary` Server Actionsのテスト（RLSポリシー検証含む）を作成
  - Middleware認証チェックのテスト（認証済み/未認証ユーザーのリダイレクト）を作成
  - _Requirements: テスト戦略に基づく_

- [ ] 12.3 E2Eテストの作成
  - 日記作成フロー（ログイン → 入力 → AI生成 → 編集 → 保存 → 一覧確認）のE2Eテストを作成
  - 日記閲覧・編集フロー（一覧 → 詳細 → 編集 → 保存 → 確認）のE2Eテストを作成
  - 日記削除フロー（詳細 → 削除確認 → 削除 → 一覧確認）のE2Eテストを作成
  - 認証フロー（未認証アクセス → ログインリダイレクト → 認証成功）のE2Eテストを作成
  - レスポンシブデザインのE2Eテスト（モバイル、タブレット、デスクトップ）を作成
  - _Requirements: テスト戦略に基づく_

- [x] 13. セキュリティ強化
- [ ] 13.1 セキュリティ脆弱性対策の実装
  - Content Security Policy (CSP)ヘッダーを設定し、XSS攻撃を防止
  - SameSite Cookie属性を設定し、CSRF攻撃を防止
  - リッチテキストエディタの出力をサニタイズし、XSS攻撃を防止
  - API Keyを環境変数として管理し、`.env.local`を`.gitignore`に追加
  - Supabase RLSポリシーが正しく適用されていることを確認
  - _Requirements: 6.3, 6.4, 6.5_

- [ ] 13.2 レートリミットの実装（将来拡張）
  - クライアントサイドでボタンの連続クリックを防止
  - サーバーサイドでレートリミット（例: 1ユーザーあたり1分間に10リクエスト）を実装（将来的に）
  - レートリミット超過時、適切なエラーメッセージ（「リクエストが多すぎます」）を表示
  - _Requirements: セキュリティ考慮事項に基づく_

- [x] 14. 最終統合とデプロイ準備
- [ ] 14.1 環境変数とビルド設定の確認
  - `.env.example`ファイルを作成し、必要な環境変数をドキュメント化
  - Vercelデプロイ用の環境変数（Supabase URL/Key、LLM API Key）を設定
  - `next.config.js`でHTTPSリダイレクト、セキュリティヘッダーを設定
  - ビルドプロセス（`npm run build`）が成功することを確認
  - _Requirements: すべての要件の統合_

- [ ] 14.2 エンドツーエンドの動作確認
  - ユーザー登録からログイン、日記作成、AI生成、編集、保存、閲覧、削除までのフルフローを手動テスト
  - モバイル、タブレット、デスクトップでUIが正しく表示されることを確認
  - AI生成が15秒以内に完了することを確認
  - ページ遷移が2秒以内に完了することを確認
  - すべてのエラーハンドリングが適切に動作することを確認
  - _Requirements: すべての要件の検証_
